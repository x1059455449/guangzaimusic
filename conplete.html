<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="referrer" content="never">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="stylesheet" href="//at.alicdn.com/t/font_448304_47new50n1nabgldi.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css">
    <script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <title>静态页面</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    html,body,main {
        height: 100%;
    }
    body {
        font: 14px/1.5 Arial;
    }
    a {
        text-decoration: none;
        color: #444;
    }
    ul,li {
        list-style: none;
    }
    html,body,section {
        height: 100%;
        overflow: hidden;
    }
    .layout {
        margin: 0 auto;
        width: 600px;
    }
    #page-cover {
        display: none;
    }
    .bg {
        /* Z-index 仅能在定位元素上奏效（例如 position:absolute;）！ */
        position: absolute;
        z-index: -1;
        left: -10px;
        right: -10px;
        top: -10px;
        bottom: -10px;
        background: url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-big) center center no-repeat;
        background-size: cover;
        filter: blur(4px);
    }
    .bg::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4)
    }

    main {
        padding-top: 12vh;
        height: calc(100% - 24vh);
    }
    main::after {
        contain: '';
        display: none;
        clear: both;
    }
    main .aside {
        float: left;
    }
    main .aside > figure {
        width: 46vh;
        height: 46vh;
        background-image: url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-middle);
        background-size: cover;
        background-position: center center;
    }
    main .aside .actions {
        display: flex;
        margin-top: 4vh;
    }
    main .aside .iconfont {
        flex: 1;
        text-align: center;
        font-size: 5vh;
        color: rgba(255,255,255,0.4);
        transition: color .4s;
        cursor: pointer;
    }
    main .aside .iconfont:hover {
        color: #fff;
    }
    main .aside .iconfont.active {
        color: aqua;
    }
    
    main .detail  {
        margin-left: 56vh;
        color: #fff;
    }
    main .detail .tag {
        font-size: 2vh;
        padding: .4em .8em;
        background: aqua;
    }
    main .detail h1 {
        font-size: 6vh;
        margin-top: 2vh;
    }
    main .icons {
        display: flex;
        font-size: 3vh;
        margin-top: 12vh;
    }
    main .icons .iconfont {
        font-size: 3vh;
        margin-right: 1vh;
    }
    main .icons li {
        flex: 1;
    }
    main .area-bar {
        margin-top: 10vh;
        display: flex;
        align-items: center;  
    }
    main .area-bar .bar {
        position: relative;
        flex: 1;
        height: .8vh;
        border-radius: .2vh;
        background: rgba(255, 255, 255, 0.4);
        cursor: pointer;
    }
    main .area-bar .bar-progress{
        position: absolute;
        height: .8vh;
        width: 0%;
        transition: width .8s;
        background-color: #fff;
        border-radius: .2vh;
    }
    main .area-bar .current-time{
        width: 3vh;
        font-size: 2vh;
        margin-left: 1vh;
    }
    main .author {
        font-size: 2vh;
        margin-top: 2vh;
        color: rgba(255, 255, 255, 0.6);
    }
    main .lyric {
        font-size: 3vh;
        margin-top: 3vh;
        color: rgba(255, 255, 255, 1);
    }
    footer {
        height: 24vh;
        color: #fff;
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0px -.25vh .25vh .25vh rgba(255,255,255,0.2);
    }
    footer>.layout{
        position: relative;
    }
    footer .box {
        position: relative;
        overflow: hidden;
        height: 24vh;
        /* 子元素设置完绝对定位后，父容器无法撑开 */
    }
    footer ul{
        position: absolute;
        left: 0;
    }
    footer ul:after {
        content: '';
        display: block;
        clear: both;
    }
    footer li{
        float: left;
        margin-top: 1vh;
        margin: 2vh 2vh 0 2vh;
        width: 20vh;
        height: 20vh;
    
        text-align: center;
        cursor: pointer;
    }
    footer li:hover {
        box-shadow: 0 0 .5vh .5vh rgba(255,255,255,0.8);
    }
    footer li .cover {
        height: 16vh;
        background-size: cover;
        background-position: center center;
    }
    footer h3{
        font-size: 2vh;
        color: rgba(255,255,255,0.6);
        margin-top: 1vh;
    }
    footer li.active {
        box-shadow: 0 0 .5vh .5vh rgba(255,255,255,0.8);
    
    }
    
    footer .iconfont {
        position: absolute;
        top: 4vh;
        font-size: 6vh;
        color: rgba(255, 255, 255, 0.4);
        opacity: 0;
        transition: all .4s;
        cursor: pointer;
    }
    footer:hover .iconfont {
        opacity: 1;
    }
    footer .iconfont:hover {
        color: rgba(255, 255, 255, 0.8);
    }
    footer .icon-left {
        left: -8vh;
    }
    footer .icon-right {
        right: -8vh;
    }
    
    .boomText{
        opacity: 0;
        display: inline-block;
    }
    @media (min-width: 700px) {
        .layout {
        width: 600px;
        }
    }
    @media (min-width: 900px) {
        .layout {
        width: 800px;
        }
    }
    @media (min-width: 1000px) {
        .layout {
        width: 900px;
        }
    }
    @media (min-width: 1200px) {
        .layout {
        width: 1100px;
        }
    }
    
    </style>
</head>
<body>
    <!-- 上半部分 -->
    <section id="page-music">
        <main class="layout">
            <!-- 左边部分 -->
            <div class="aside">
                <!-- 这里不写img,写了要固定宽高，图片也容易变形 -->
                <figure></figure>
                <div class="actions">
                    <span class="btn-collect iconfont icon-heart"></span>
                    <span class="btn-play iconfont icon-pause"></span>
                    <span class="btn-next iconfont icon-next"></span>
                </div>
            </div>
            <!-- 右边部分 -->
            <div class="detail">
                <span class="tag">music</span>
                <h1>It's a new day</h1>
                <ul class="icons">
                    <li><span class="iconfont icon-earphone"></span></li>
                    <li><span class="iconfont icon-heart"></span></li>
                    <li><span class="iconfont icon-like"></span></li>
                </ul>
                <div class="area-bar">
                    <div class="bar">
                        <div class="bar-progress"></div>
                    </div>
                    <div class="current-time">0:00</div>
                </div>
                <div class="author">GG</div>
                <div class="lyric">
                    <p></p>
                </div>
            </div>
        </main>
        <footer>
            <div class="layout">
                <!-- 这两句放在box前后是不一样的，关系到左右按钮隐藏与否 -->
                <span class="iconfont icon-left"></span>
                <span class="iconfont icon-right"></span>
                <div class="box">
                    <ul>
                        <li>
                        <div class="cover" style="background-image:url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small)"></div>
                         <h3>1</h3>   
                        </li>
                        <li>
                        <div class="cover" style="background-image:url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small)"></div>
                        <h3>2</h3>    
                        </li>
                        <li>
                        <div class="cover" style="background-image:url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small)"></div>
                        <h3>3</h3> 
                        </li>
                        <li>
                        <div class="cover" style="background-image:url(http://cloud.hunger-valley.com/music/public_tuijian_spring.jpg-small)"></div>
                        <h3>4</h3>         
                        </li>
                    </ul>
                </div>
            </div>
        </footer>
    </section>
    <section id="page-cover"></section>
    <div class="bg"></div>
    <script>
    //自定义事件
    var EventCenter = {
        on: function(type, handler){
        $(document).on(type, handler)
    },
        fire: function(type, data){
        $(document).trigger(type, data)
        }
    }
    // EventCenter.on('hello', function(e, data){
    //   console.log(data)
    // })
    // EventCenter.fire('hello', '你好')
    var Footer = {
        init: function () {
            this.$footer = $('footer')
            this.$ul = this.$footer.find('ul')
            this.$box = this.$footer.find('.box')
            this.$leftBtn = this.$footer.find('.icon-left')
            this.$rightBtn = this.$footer.find('.icon-right')
            this.isToEnd = false
            this.isToStart = true
            this.isAnimate = false
            this.bind()
            this.render()
        },
        bind: function () {
            var _this = this
            $(window).resize(function () {
                _this.setStyle()
            })
            this.$rightBtn.on('click',function () {
                if(_this.isAnimate) return
                var itemWidth = _this.$box.find('li').outerWidth(true)
                var rowCount = Math.floor(_this.$box.width()/itemWidth)
                console.log(itemWidth,rowCount)
                if(!_this.isToEnd){
                _this.isAnimate = true
                _this.$ul.animate({
                    left:'-=' + rowCount * itemWidth
                },400,function () {
                    _this.isAnimate = false
                    _this.isToStart = false
                    if(parseFloat(_this.$box.width()) - parseFloat(_this.$ul.css('left')) >= parseFloat(_this.$ul.css('width'))){
                       _this.isToEnd = true
                       console.log('end') 
                    }
                })
                }
            })
            this.$leftBtn.on('click',function () {
                if(_this.isAnimate) return
                var itemWidth = _this.$box.find('li').outerWidth(true)
                var rowCount = Math.floor(_this.$box.width()/itemWidth)
                if(!_this.isToStart){
                _this.isAnimate = true
                _this.$ul.animate({
                    left:'+=' + rowCount * itemWidth
                },400,function () {
                    _this.isAnimate = false
                    _this.isToEnd = false
                    if(parseFloat(_this.$ul.css('left')) >= 0){
                       _this.isToStart= true
                       console.log('start') 
                    }
                })
                }
            })
            //事件代理
            this.$footer.on('click','li',function () {
                $(this).addClass('active').siblings()
                .removeClass('active')
                EventCenter.fire('select-albumn',{
                    channelId: $(this).attr('data-channel-id'),
                    channelName: $(this).attr('data-channel-name')
                })
            })
        },
        render: function () {
            var _this = this
            $.getJSON('//jirenguapi.applinzi.com/fm/getChannels.php')
            .done(function (ret) {
                console.log(ret);
                _this.renderFooter(ret.channels)
            }).fail(function () {
                console.log('failed get data')
            })
        },
        renderFooter: function (channels) {
            console.log(channels);
            var html = ''
            channels.unshift({
                channel_id: 0,
                name: '我的最爱',
                cover_small: 'http://cloud.hunger-valley.com/17-10-24/1906806.jpg-small',
                cover_middle: 'http://cloud.hunger-valley.com/17-10-24/1906806.jpg-middle',
                cover_big: 'http://cloud.hunger-valley.com/17-10-24/1906806.jpg-big'
                })
            channels.forEach(function (channel) {
                html += '<li data-channel-id='+channel.channel_id+' data-channel-name='+channel.name+'>'
                        + '  <div class="cover" style="background-image:url('+channel.cover_small+')"></div>'
                        + '  <h3>'+channel.name+'</h3>'
                        +'</li>'
           })
           this.$ul.html(html)
           this.setStyle()
        },
        setStyle: function () {
            //这里的li是通过Ajax获取的，所以一开始不能直接在上面写，否则得到的li是空的
            var count = this.$footer.find('li').length
            var width = this.$footer.find('li').outerWidth(true)
            console.log(count,width);
            this.$ul.css({
                width: count * width + 'px' 
            })
        }
    }
    var Fm = {
        init: function () {
            this.$container = $('#page-music')
            this.audio = new Audio()
            this.audio.autoplay = true
            this.percent = 0
            this.collections = this.loadFromLocal()
            this.currentSong = null
            this.bind()

            EventCenter.fire('select-albumn', {
            channelId: 'public_tuijian_suibiantingting',
            channelName: '随便听听'
            })
        },
        bind: function () {
            var _this = this
            EventCenter.on('select-albumn',function (e,channelObj) {
                _this.channelId = channelObj.channelId
                _this.channelName = channelObj.channelName
                //console.log(_this.channelId)
                //console.log(_this.channelName)
                _this.loadMusic(function () {
                    _this.setMusic()
                })
                //console.log('select',channelId)
            })

            this.$container.find('.btn-play').on('click',function () {
                var $btn = $(this)
                if($btn.hasClass('icon-play')){
                    $btn.removeClass('icon-play').addClass('icon-pause')
                    _this.audio.play()//注意此处_this和this指向不一样
                }else{
                    $btn.removeClass('icon-pause').addClass('icon-play')
                    _this.audio.pause()
                }
            })
            this.$container.find('.btn-next').on('click',function () {
                _this.loadMusic(function () {
                    _this.setMusic()
                })
            })
            //对播放中的歌曲进行监听
            this.audio.addEventListener('play',function () {
                console.log('play')
                clearInterval(_this.statusClock)
                _this.statusClock = setInterval(function () {
                    _this.updateStatus()
                },1000)
            })
            this.audio.addEventListener('pause',function () {
                console.log('pause')
                clearInterval(_this.statusClock)
            })
            this.audio.addEventListener('ended',function () {
                console.log('ended')
                clearInterval(_this.statusClock)
                _this.loadMusic()
            })
            
            //鼠标滑动
            this.$container.find('.bar').on('click',(params)=>{
              this.percent = params.offsetX/this.$container.find('.bar').width()
                this.audio.currentTime = this.percent*this.audio.duration
                //progressNowNode.style.width = percent*100 + '%'
                this.updateStatus()
            })
            //收藏功能
            this.$container.find('.actions .btn-collect').on('click',(e)=>{
                var $btncollect = $(e.target)
                if($btncollect.hasClass('active')){
                    $btncollect.removeClass('active')
                    delete this.collections[this.currentSong.sid]
                }else{
                    $btncollect.addClass('active')
                    this.collections[this.currentSong.sid] = this.currentSong
                }
                this.saveToLocal()
            })
        },
        loadMusic () {
            var _this = this
            console.log('loadMusic...')
            //播放我的最爱
            if(_this.channelId === '0'){
                _this.loadCollection()
            }else{
            //前面不加协议，表示当前的协议和我当前页面的url的协议是一样的
            //这样写即使代码放到别的https协议的网站上也是可以使用的
            $.getJSON('//jirenguapi.applinzi.com/fm/getSong.php',{channel: this.channelId})
            .done(function (ret) {
                _this.song = ret['song'][0]
                //console.log(ret['song'][0])
                _this.setMusic(_this.song)//callback()
                _this.loadLyric()
            })
            }
        },
        setMusic (song) {
            //共用了loadMusic的this.song
            console.log('setMusic...')
            //console.log(this.song)
            this.currentSong = song 
            this.audio.src = song.url
            $('.bg').css('background-image','url('+song.picture+')')
            this.$container.find('.aside figure').css('background-image','url('+song.picture+')')
            this.$container.find('.detail h1').text(song.title)
            this.$container.find('.detail .author').text(song.artist)
            this.$container.find('.tag').text(this.channelName)
            this.$container.find('.btn-play').removeClass('icon-play').addClass('icon-pause')
            this.$container.find('.icon-earphone').text(this.getRandomInt(100,8000))
            this.$container.find('.icons .icon-heart').text(this.getRandomInt(100,5000))
            this.$container.find('.icon-like').text(this.getRandomInt(100,5000))

            if(this.collections[song.sid]){
                this.$container.find('.btn-collect').addClass('active')
            }else{
                this.$container.find('.btn-collect').removeClass('active')
            }
        },
        updateStatus () {
            console.log('updating...')
            var min = Math.floor(this.audio.currentTime/60)
            var second = Math.floor(Fm.audio.currentTime%60)+''//加空格就是变成字符串,注意位置
            second = second.length ===2?second:'0' + second
            this.$container.find('.current-time').text(min+ ':' +second)
            this.$container.find('.bar-progress').css('width',this.audio.currentTime/this.audio.duration*100 + '%')
            //console.log(this.lyricObj['0'+min+':'+second])
            var line = this.lyricObj['0'+min+':'+second]
            //console.log('0'+min+':'+second)
            console.log(line)
            if(line){
                this.$container.find('.lyric p').text(line)
                .boomText('zoomIn')
            } 
        },
        loadLyric () {
            var _this = this
            $.getJSON('//jirenguapi.applinzi.com/fm/getLyric.php',{sid: this.song.sid})
            .done(function (ret) {
                //window.lyric = lyric
                //console.log(ret.lyric)
                //[01:10.25][01:20.25]It a new day
                //times == ['01:10.25', '01:20.25']
                var lyric = ret.lyric
                var lyricObj = {}
                lyric.split('\n').forEach(function (line) {
                    var times = line.match(/\d{2}:\d{2}/g)
                    var str = line.replace(/\[.+?\]/g,'')
                    if(Array.isArray(times)){
                        times.forEach(function (time) {
                            lyricObj[time] = str
                        })
                    }
                })
                _this.lyricObj = lyricObj
                console.log(this.lyricObj)
            })
        },
        getRandomInt(min,max){
            return Math.floor(Math.random()*(max-min+1)) + min
        },
        loadCollection(){
            let keyArray = Object.keys(this.collections)
            if(keyArray.length === 0) return 
            let randomIndex = Math.floor(Math.random()*keyArray.length)
            let randomSid = keyArray[randomIndex]
            this.setMusic(this.collections[randomSid])
        },
        saveToLocal(){
            localStorage['collections'] = JSON.stringify(this.collections)
        },
        loadFromLocal(){
            return JSON.parse(localStorage['collections']||'{}')
        }
    }
    //http://js.jirengu.com/zuvar/1/edit?html,js,console,output
    $.fn.boomText = function(type){
    type = type || 'rollIn'
    console.log(type)
    this.html(function(){
        var arr = $(this).text()
        .split('').map(function(word){
            return '<span class="boomText">'+ word + '</span>'
        })
        return arr.join('')
    })
    
    var index = 0
    var $boomTexts = $(this).find('span')
    var clock = setInterval(function(){
        $boomTexts.eq(index).addClass('animated ' + type)
        index++
        if(index >= $boomTexts.length){
        clearInterval(clock)
        }
    }, 300)
    }
    //$('p').boomText('rollIn') //  https://github.com/daneden/animate.css
    Footer.init()
    Fm.init()


    </script>
</body>
</html>